<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <title>LOST?</title>

    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>

    <!-- Load polyfills to support older browsers -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"></script>

    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>
    <script src="js/dexie.js"></script>
    <script src="js/libgif.js"></script>

    <script src="js/ethers-5.2.umd.min.js"></script>
    <script src="js/bignumber.min.js"></script>
    <!-- <script src="js/apexcharts.js"></script> -->

    <!-- ENS stuff -->
    <script src="js/punycode.js"></script>
    <script src="js/idna-map.js"></script>
    <script src="js/idna-uts46-hx.js"></script>
    <script src="js/js-sha3.js"></script>
    <script src="js/eth-ens-namehash.js"></script>

    <script src="bastardData.min.js"></script>
    <script src="deploymentData.js"></script>
    <script src="ensMapSnapshot.js"></script>
    <script src="ownersSnapshot.js"></script>

    <link rel="apple-touch-icon" sizes="57x57" href="images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-2">
        <div>
          <b-navbar variant="light">
            <b-navbar-brand to="./" variant="primary" v-b-popover.hover.bottom="'LOST? OpenSea Explorer'" class="mr-5">
              LOST?
            </b-navbar-brand>
            <div v-for="item in getSelectedShowcase">
              <b-link @click="displayToken('./images/' + item.image)">
                <b-avatar rounded="sm" variant="light" size="3.0rem" :src="'./images/' + item.image" v-b-popover.hover.bottom="'#' + item.tokenId" class="ml-2"></b-avatar>
              </b-link>
            </div>
            <b-navbar-nav class="ml-auto">
              <b-button size="sm" variant="outline-primary" class="ml-4" v-b-popover.hover="'Connect via Web3'" @click="connect();" v-if="!connected">Connect</b-button>
              <b-button size="sm" variant="outline-primary" class="ml-4" v-b-popover.hover="'Your wallet'" @click="disconnect();" v-if="connected">{{ ensOrShortName(account) }}</b-button>
            </b-navbar-nav>
          </b-navbar>
        </div>

        <div>
          <b-card no-body class="mt-1">
            <div>
              <!-- <b-modal size="xl" ref="gif-frame-extraction-modal" hide-footer @shown="onGIFFrameSelectionModalOpened" class="w-100"> -->
              <b-modal ref="gif-frame-extraction-modal" hide-footer @shown="onGIFFrameSelectionModalOpened" dialog-class="mw-100 w-50">
                <template #modal-title>
                  {{ selectedTokenId == null ? null : selectedTokenId }}
                  <span v-if="selectedItemIsGIF"> - Frame {{ selectedItemFrame == null ? '(loading)' : selectedItemFrame }}</span>
                </template>
                <div class="d-block text-center">
                  <img id="thegif1" :src="selectedTokenId == null ? null : selectedTokenId" :rel:animated_src="selectedTokenId == null ? null : selectedTokenId" width="600" height="600" rel:auto_play="0" rel:rubbable="1" class="pr-3" />
                </div>
                <b-input-group v-if="selectedItemIsGIF">
                  <template #prepend>
                    <b-form-spinbutton wrap @change="setFrame()" v-model.trim="selectedItemFrame" min="0" :max="selectedItemFrames == null ? 0 : (selectedItemFrames - 1)" class="mr-2"></b-form-spinbutton>
                    <b-input-group-text>0</b-input-group-text>
                  </template>
                  <b-form-input @change="setFrame()" v-model.trim="selectedItemFrame" type="range" min="0" :max="selectedItemFrames == null ? 0 : (selectedItemFrames - 1)" class="w-25"></b-form-input>
                  <template #append>
                    <b-input-group-text>{{ selectedItemFrames == null ? 0 : (selectedItemFrames - 1) }}</b-input-group-text>
                  </template>
                </b-input-group>
              </b-modal>
            </div>

            <template>
              <div>
                <b-sidebar right id="sidebar-border" sidebar-class="border-right border-danger">
                  <div v-for="(categoryKey, categoryIndex) in Object.keys(categories).sort()" v-bind:key="categoryIndex">
                    <b-card body-class="p-0" header-class="m-0 p-0 pl-2" footer-class="p-1" class="m-3 p-0">
                      <template #header>
                        <span variant="secondary" class="small truncate">
                          {{ categoryKey }}
                        </span>
                      </template>
                      <font size="-2">
                        <b-table small fixed striped sticky-header="200px" :fields="categoryFields" :items="getSortedValuesForCategory(categoryKey)" head-variant="light">
                          <template #cell(select)="data">
                            <b-form-checkbox @change="filterChange(categoryKey, data.item.categoryOption)"></b-form-checkbox>
                          </template>
                        </b-table>
                      </font>
                    </b-card>
                  </div>
                </b-sidebar>
              </div>
            </template>

            <div v-if="processing == null && settings.searchAccount != null && settings.searchAccount.length > 0 && collatedOwners.length == 0">
              <b-jumbotron header="WEB3 CONNECTION REQUIRED" bg-variant="info" text-variant="white" border-variant="dark" class="m-5 p-5">
                TO RETRIEVE ERC-721 TOKEN OWNERSHIP AND ENS INFOMRATION. YOU CAN CONTINUE USING THIS TOOL WITHOUT A CONNECTION BUT OWNER INFORMATION AND SEARCH WILL NOT WORK. CLICK ON THE BUTTON ON THE TOP RIGHT TO CONNECT. CLEAR THE OWNER SEARCH FIELD TO REMOVE THIS MESSAGE.
              </b-jumbotron>
            </div>

            <div v-if="processing != null">
              <b-jumbotron header="PROCESSING" bg-variant="info" text-variant="white" border-variant="dark" class="m-5 p-5">
                {{ processing }}
              </b-jumbotron>
            </div>

            <b-tabs card v-model="tabIndex" align="right">

              <b-tab title="SEXY BASTARDS">
                <b-card-text>
                  <div class="d-flex m-0 p-0" style="height: 37px;">
                    <div>
                      <b-form-input type="text" size="sm" @change="recalculate('searchTokenId')" v-model.trim="settings.searchTokenId" debounce="600" placeholder="ðŸ” ID1, ID2, ..."></b-form-input>
                    </div>
                    <div class="pl-2">
                      <b-form-input type="text" size="sm" @change="recalculate('searchAccount')" v-model.trim="settings.searchAccount" debounce="600" placeholder="ðŸ” ENS1, ADDY2, ..."></b-form-input>
                    </div>
                    <div class="pl-2">
                      <b-button size="sm" @click="settings.searchAccount = account; recalculate('mySexyBastards')" variant="outline-primary"><< MY SEXY BASTARDS</b-button>
                    </div>
                    <div class="pl-2">
                      <b-button size="sm" :pressed.sync="settings.advancedSearch" @click="saveSettings('advancedSearch')" variant="outline-primary" v-b-popover.hover="'ADVANCED SEARCH'"><span v-if="settings.advancedSearch"><b-icon-chevron-double-up shift-v="+1" font-scale="1.0"></b-icon-chevron-double-up></span><span v-else><b-icon-chevron-double-down shift-v="+1" font-scale="1.0"></b-icon-chevron-double-down></span></b-button>
                    </div>
                    <div class="pr-1 flex-grow-1">
                    </div>
                    <div class="pl-2">
                      <font size="-2">{{ tokensSearchResults.length }}/{{ getTotalSupply }}</font>
                    </div>
                    <div class="pl-2">
                      <b-pagination size="sm" v-model="tokensCurrentPage" :total-rows="tokensSearchResults.length" :per-page="tokensPageSize"></b-pagination>
                    </div>
                    <div class="pl-2">
                      <b-form-select size="sm" v-model="tokensPageSize" :options="pageSizes"></b-form-select>
                    </div>
                    <div class="pl-2" v-if="settings.cardView">
                      <b-form-select size="sm" v-model="cardImageSizeCurrent" :options="cardImageSizeOptions"></b-form-select>
                    </div>
                    <div class="pl-2">
                      <b-button size="sm" :pressed.sync="settings.cardView" @click="saveSettings('cardView')" variant="link" v-b-popover.hover="'LIST OR CARD VIEW'"><span v-if="settings.cardView"><b-icon-list-ol shift-v="+1" font-scale="1.0"></b-icon-list-ol></span><span v-else><b-icon-grid3x3-gap shift-v="+1" font-scale="1.0"></b-icon-grid3x3-gap></span></b-button>
                      <b-button size="sm" v-b-toggle.sidebar-border variant="link" v-b-popover.hover="'ADVANCED SERACH'"class="m-0 p-0"><b-icon-search shift-v="+.5" font-scale="1.2"></b-icon-search></b-button>
                    </div>
                  </div>

                  <div>
                    <!-- visible -->
                    <b-collapse v-model="settings.advancedSearch" class="m-2">
                      <b-card>
                        <b-card-group deck>
                          <b-card header="QUICK FILTER" style="min-width: 20rem; max-width: 20rem;" class="mb-2">
                            <b-card-text>
                              <!-- <b-form-input type="text" size="sm" @change="recalculate('searchTokenId')" v-model.trim="settings.searchTokenId" debounce="600" placeholder="ðŸ” ID1, ID2, ..." class="mb-2"></b-form-input> -->

                              <!-- <b-input-group v-if="selectedItemIsGIF">
                                <template #prepend>
                                  <b-form-spinbutton wrap @change="setFrame()" v-model.trim="selectedItemFrame" min="0" :max="selectedItemFrames == null ? 0 : (selectedItemFrames - 1)" class="mr-2"></b-form-spinbutton>
                                  <b-input-group-text>0</b-input-group-text>
                                </template>
                                <b-form-input @change="setFrame()" v-model.trim="selectedItemFrame" type="range" min="0" :max="selectedItemFrames == null ? 0 : (selectedItemFrames - 1)" class="w-25"></b-form-input>
                                <template #append>
                                  <b-input-group-text>{{ selectedItemFrames == null ? 0 : (selectedItemFrames - 1) }}</b-input-group-text>
                                </template>
                              </b-input-group> -->

                              <!-- <b-input-group size="sm" > -->
                                <b-form-input type="text" size="sm" @change="recalculate('searchTokenId')" v-model.trim="settings.searchTokenId" debounce="600" placeholder="ðŸ” ID1, ID2, ..." class="mb-2"></b-form-input>
                                <!-- <template #append>
                                  <b-button :disabled="settings.searchTokenId.length == 0" @click="settings.searchAccount = account; recalculate('mySexyBastards')" variant="outline-primary" class="mb-2">{{ getURL(settings.searchTokenId)}}</b-button>
                                </template>
                              </b-input-group> -->
                              <!-- <b-input-group size="sm" > -->
                                <b-form-input type="text" size="sm" @change="recalculate('searchAccount')" v-model.trim="settings.searchAccount" debounce="600" placeholder="ðŸ” ENS1, ADDY2, ..." class="mb-2"></b-form-input>
                                <!-- <template #append>
                                  <b-button :disabled="settings.searchAccount.length == 0" @click="settings.searchAccount = account; recalculate('mySexyBastards')" variant="outline-primary" class="mb-2 w-50">{{ getURL(settings.searchAccount)}}</b-button>
                                </template>
                              </b-input-group> -->

                              <b-form-input type="text" size="sm" @change="recalculate('searchLyrics')" v-model.trim="settings.searchLyrics" debounce="600" placeholder="ðŸ” LYRICS" class="mb-2"></b-form-input>
                            </b-card-text>
                          </b-card>
                          <b-card header="FILTER BY TAGS" style="min-width: 20rem; max-width: 20rem;" class="mb-2">
                            <b-card-text>
                              <b-form-select size="sm" @change="recalculate('selectedTags')" v-model="selectedTags" :options="getTags" multiple :select-size="10" variant="outline-primary"></b-form-select>
                            </b-card-text>
                          </b-card>

                          <!--
                          <div v-for="(categoryKey, categoryIndex) in Object.keys(categories).sort()" v-bind:key="categoryKey">
                            <b-card style="min-width: 20rem; max-width: 20rem;" class="mb-2">
                              <template #header>
                                <span variant="secondary">
                                  {{ categoryKey }}
                                </span>
                                <font size="-2">
                                  <b-table small fixed striped sticky-header="200px" :fields="categoryFields" :items="getSortedValuesForCategory(categoryKey)" head-variant="light">
                                    <template #cell(select)="data">
                                      <b-form-checkbox @change="filterChange(categoryKey, data.item.categoryOption)"></b-form-checkbox>
                                    </template>
                                  </b-table>
                                </font>
                              </template>
                              <b-card-text>
                              </b-card-text>
                            </b-card>
                          </div>
                          -->
                        </b-card-group>
                      </b-card>
                    </b-collapse>
                  </div>

                  <div v-if="settings.cardView">
                    <b-card-group deck>
                      <div v-for="record in pagedTokensResults">
                        <b-card body-class="p-1" header-class="p-1" footer-class="p-1" img-top class="m-2 p-1 border-0">
                          <b-link @click="displayToken(record.tokenId)" v-b-popover.hover="'CLICK FOR DETAILS'">
                            <b-img-lazy :width="cardImageSizeCurrent + '%'" :src="record.osimage" />
                          </b-link>
                          <b-card-text>
                            <b-link :href="'https://www.bastardganpunks.club/v2/' + record.tokenId" v-b-popover.hover="'VIEW NFT IN ORIGNIAL WEBSHITE'" target="_blank">
                              {{ '#' + record.tokenId }}
                            </b-link>
                            <b-link :href="'https://opensea.io/accounts/' + owners[record.tokenId]" v-b-popover.hover="'VIEW OWNER ACCOUNT IN OPENSEA'" target="_blank">
                              {{ ensOrShortName(owners[record.tokenId]) }}
                            </b-link>
                            <b-link v-if="cardImageSizeCurrent >= 200" size="sm" @click="settings.searchAccount = owners[record.tokenId]; tabIndex = 0; recalculate('tokenSearch'); " v-b-popover.hover="'FILTER BY OWNER ACCOUNT'" variant="link">
                              <b-icon-search shift-v="+1" font-scale="0.8"></b-icon-search>
                            </b-link>
                            <span v-if="record.mosaicurl != null && cardImageSizeCurrent >= 200">
                              <b-link :href="record.mosaicurl" v-b-popover.hover="'VIEW HYPED AF (ANIMATED) MOSAIC'" target="_blank">
                                <b-icon-grid3x3-gap shift-v="+1" font-scale="0.8"></b-icon-grid3x3-gap>
                              </b-link>
                            </span>
                            <!-- TODO
                            <span v-if="record.mosaicurl == null && cardImageSizeCurrent >= 200">
                              <b-link :href="record.mosaicurl" v-b-popover.hover="'VIEW HYPED AF (ANIMATED) MOSAIC'" target="_blank">
                                <b-icon-grid3x3-gap shift-v="+1" font-scale="0.8"></b-icon-grid3x3-gap>
                              </b-link>
                            </span> -->
                            <b-link v-if="cardImageSizeCurrent >= 200" :href="record.permalink + '?ref=0x000001f568875F378Bf6d170B790967FE429C81A'" target="_blank">
                              <span v-if="osData[record.tokenId] && osData[record.tokenId].sellOrder"><b-icon-cart-fill shift-v="+1" font-scale="0.8" v-b-popover.hover="'FOR SALE IN OPENSEA'"></b-icon-cart-fill></span><span v-else><b-icon-cart4 shift-v="+1" font-scale="0.8" v-b-popover.hover="'NOT FOR SALE IN OPENSEA'"></span>
                            </b-link>
                            <span v-if="cardImageSizeCurrent >= 200">
                              <font size="-2">
                                <b-form-tags size="sm" @input="saveTags" v-model="tags[record.tokenId]" tag-variant="primary" tag-pills separator=" " v-b-popover.hover="'ENTER NEW TAGS'" placeholder="" class="ml-0 mt-1 mw-100"></b-form-tags>
                              </font>
                            </span>
                          </b-card-text>
                        </b-card>
                      </div>
                    </b-card-group>
                  </div>

                  <div v-if="!settings.cardView">
                    <b-table small :fields="fields" :items="pagedTokensResults" responsive="sm">
                      <template #cell(image)="data">
                        <b-link @click="displayToken(data.item.tokenId)" v-b-popover.hover="'Click for details'">
                          <b-img-lazy width="300%" :src="data.item.osimage" />
                          <!-- <b-avatar rounded="sm" variant="light" size="10.0rem" :src="data.item.osimage"></b-avatar> -->
                        </b-link>
                      </template>
                      <template #cell(tokenId)="data">
                        <b-link :href="'https://www.bastardganpunks.club/v2/' + data.item.tokenId" v-b-popover.hover="'VIEW NFT IN ORIGNIAL WEBSHITE'" target="_blank">
                          {{ '#' + data.item.tokenId }}
                        </b-link>
                        <br />
                        <span v-if="owners.length > 0">
                          <b-link :href="'https://opensea.io/accounts/' + owners[data.item.tokenId]" v-b-popover.hover="'VIEW OWNER ACCOUNT IN OPENSEA'" target="_blank">
                            <font size="-2">{{ ensOrShortName(owners[data.item.tokenId]) }}</font>
                          </b-link>
                        </span>
                        <b-link size="sm" @click="settings.searchAccount = owners[data.item.tokenId]; tabIndex = 0; recalculate('tokenSearch'); " v-b-popover.hover="'FILTER BY OWNER ACCOUNT'" variant="link">
                          <b-icon-search shift-v="+1" font-scale="0.8"></b-icon-search>
                        </b-link>
                        <span v-if="data.item.hasMosaic">
                          <b-link :href="'hypedafmosaic/' + data.item.tokenId + '.png'" v-b-popover.hover="'VIEW HYPED AF (ANIMATED) MOSAIC'" target="_blank">
                            <b-icon-grid3x3-gap shift-v="+1" font-scale="0.8"></b-icon-grid3x3-gap>
                          </b-link>
                        </span>
                        <span v-if="!data.item.hasMosaic">
                          <b-link :href="'hypedafmosaic/' + data.item.tokenId + '.png'" v-b-popover.hover="'VIEW HYPED AF (ANIMATED) MOSAIC'" target="_blank">
                            <b-icon-patch-question shift-v="+1" font-scale="0.8"></b-icon-patch-question>
                          </b-link>
                        </span>
                        <!--
                        TODO
                        <span>
                          <b-link :href="'????/' + data.item.tokenId + '.png'" v-b-popover.hover="'VIEW RAW DATA'" target="_blank">
                            <b-icon-file-text shift-v="+1" font-scale="0.8"></b-icon-file-text>
                          </b-link>
                        </span>
                        -->
                        <b-link :href="data.item.permalink + '?ref=0x000001f568875F378Bf6d170B790967FE429C81A'" target="_blank">
                          <span v-if="osData[data.item.tokenId] && osData[data.item.tokenId].sellOrder"><b-icon-cart-fill shift-v="+1" font-scale="0.8" v-b-popover.hover="'FOR SALE IN OPENSEA'"></b-icon-cart-fill></span><span v-else><b-icon-cart4 shift-v="+1" font-scale="0.8" v-b-popover.hover="'NOT FOR SALE IN OPENSEA'"></b-icon-cart4></span>
                        </b-link>
                        <b-form-tags size="sm" @input="saveTags" v-model="tags[data.item.tokenId]" tag-variant="primary" tag-pills size="sm" separator=" " v-b-popover.hover="'ENTER NEW TAGS'" placeholder="" class="ml-0 mt-1"></b-form-tags>
                        <div v-if="osData[data.item.tokenId] && osData[data.item.tokenId].sellOrder">
                          <b-button size="sm" variant="warning" :href="data.item.permalink + '?ref=0x000001f568875F378Bf6d170B790967FE429C81A'" v-b-popover.hover="'PURCHASE IN OPENSEA'" target="_blank" class="m-1 p-1">
                            <b-badge size="sm" variant="light">{{ commify(osData[data.item.tokenId].sellOrder.currentPrice) }}</b-badge>
                            {{ osData[data.item.tokenId].sellOrder.symbol }} <font size="-2">{{ formatDate(osData[data.item.tokenId].sellOrder.listingTime) }}</font>
                          </b-button>
                        </div>
                        <div v-if="osData[data.item.tokenId] && osData[data.item.tokenId].lastSale">
                          <b-button size="sm" variant="success" :href="'https://etherscan.io/tx/' + osData[data.item.tokenId].lastSale.tx" v-b-popover.hover="'VIEW PURCHASE IN BLOCK EXLPORER'" target="_blank" class="m-1 p-1">
                            <b-badge size="sm" variant="light">{{ commify(osData[data.item.tokenId].lastSale.totalPrice) }}</b-badge>
                            {{ osData[data.item.tokenId].lastSale.symbol }} <font size="-2">{{ formatDate(osData[data.item.tokenId].lastSale.eventTimestamp) }}</font>
                          </b-button>
                        </div>
                      </template>
                      <template #cell(description)="data">
                        <span v-for="line in data.item.description.split('\n')">
                          <b>{{ line }}</b><br />
                        </span>
                      </template>
                      <template #cell(attributes)="data">
                        <b-row v-for="attribute in data.item.attributes"  v-bind:key="attribute.trait_type" class="m-0 p-0">
                          <b-col class="m-0 p-0"><font size="-3">{{ attribute.trait_type }}</font></b-col><b-col class="m-0 p-0"><b><font size="-2">{{ attribute.value }}</font></b></font></b-col>
                        </b-row>
                      </template>
                    </b-table>
                  </div>
                </b-card-text>
              </b-tab>

              <b-tab title="SYNC DATA">
                <b-card-text>
                  <b-card header="Initial Sync For ERC-721 New Token Contracts" style="min-width: 60rem; max-width: 60rem;" class="mb-2">
                    <b-card-text>

                      <b-form-group label-cols="4" content-cols="8" label="Contract address" label-align="right" description="Only ERC-721 contracts supported. Small data set e.g. BGANPUNKSV1 '0x9126B817CCca682BeaA9f4EaE734948EE1166Af1'" class="mb-1">
                        <b-form-input size="sm" v-model="settings.contract.address" placeholder="Enter contract address"></b-form-input>
                      </b-form-group>

                      <b-form-group label-cols="4" content-cols="8" label="" :description="connected ? 'Retrieve ERC721 Info' : 'Please click Connect on the top right'" class="mb-1">
                        <b-button :disabled="!connected" size="sm" @click="loadERC721TokenInfo()" variant="outline-primary">
                          Retrieve ERC-721 Token Info Via Web3
                        </b-button>
                      </b-form-group>

                      <b-form-group label-cols="4" content-cols="8" label="Symbol" label-align="right" class="mb-1">
                        <b-form-input size="sm" v-model="settings.contract.symbol" readonly class="w-50"></b-form-input>
                      </b-form-group>

                      <b-form-group label-cols="4" content-cols="8" label="Name" label-align="right" class="mb-1">
                        <b-form-input size="sm" v-model="settings.contract.name" readonly></b-form-input>
                      </b-form-group>

                      <b-form-group label-cols="4" content-cols="8" label="Total Supply" label-align="right" class="mb-1">
                        <b-form-input size="sm" v-model="settings.contract.totalSupply" readonly class="w-50"></b-form-input>
                      </b-form-group>

                      <b-form-group label-cols="4" content-cols="8" label="" :description="owners.length + ' tokenIds with ' + Object.keys(ensMap).length + ' ENS records loaded'" class="mb-1">
                        <b-button :disabled="!connected || settings.contract.totalSupply == null" size="sm" @click="loadERC721TokenIdsAndOwners()" variant="outline-primary">
                          Retrieve ERC-721 TokenIds And Owners Via Web3
                        </b-button>
                      </b-form-group>

                      <b-form-group label-cols="4" content-cols="8" label="" :description="settings.contract.totalSupply != null ? 'Retrieve OS Info' : 'Please retrieve ERC-721 info above'" class="mb-1">
                        <b-button :disabled="settings.contract.totalSupply == null" size="sm" @click="loadOSData()" variant="outline-primary">
                          Retrieve OS Data
                        </b-button>
                      </b-form-group>

                      <b-form-group v-if="settings.contract.loaded != null" label-cols="4" content-cols="8" label="Loading" label-align="right" class="mb-1">
                        <b-progress :max="settings.contract.totalSupply" height="2rem" variant="success" striped :animated="true">
                          <b-progress-bar :value="settings.contract.loaded">
                            <span><strong>{{ commify(parseInt(settings.contract.loaded) + 1) }} {{ ((parseInt(settings.contract.loaded) + 1) * 100 / settings.contract.totalSupply).toFixed(2) }}%</strong></span>
                          </b-progress-bar>
                        </b-progress>
                      </b-form-group>


                      <!-- <b-row class="mt-1">
                        <b-col cols="4"></b-col>
                        <b-col cols="8">
                          <b-button size="sm" @click="loadOSData()" variant="outline-primary">
                            SYNC OPENSEA SALES AND LISTINGS DATA
                          </b-button>
                        </b-col>
                      </b-row> -->
                      <!-- <b-form-select size="sm" @change="recalculate('selectedTags')" v-model="selectedTags" :options="getTags" multiple :select-size="10" variant="outline-primary"></b-form-select> -->
                    </b-card-text>
                  </b-card>
                </b-card-text>
              </b-tab>

              <b-tab lazy title="OWNERS">
                <b-card-text>
                  <div class="d-flex m-0 p-0" style="height: 37px;">
                    <div class="pr-1 flex-grow-1">
                    </div>
                    <div class="pl-2">
                      <font size="-2">Unique Owners: {{ collatedOwners.length }} ({{ ((collatedOwners.length*100)/getTotalSupply).toFixed(2) + '%' }}); Total Supply: {{ getTotalSupply }}. Connect your wallet to retrieve up-to-date owner data</font>
                    </div>
                    <div class="pl-2">
                      <b-pagination size="sm" v-model="ownersCurrentPage" :total-rows="collatedOwners.length" :per-page="tokensPageSize"></b-pagination>
                    </div>
                    <div class="pl-2">
                      <b-form-select size="sm" v-model="ownersPageSize" :options="pageSizes"></b-form-select>
                    </div>
                  </div>

                  <b-table small :fields="ownersFields" :items="pagedCollatedOwnersResults" responsive="sm">
                    <template #cell(index)="data">
                      {{ data.item.index }}
                    </template>
                    <template #cell(owner)="data">
                      {{ ensOrShortName(data.item.owner) }}<br />
                      {{ data.item.tokens.length + ' (' + (data.item.tokens.length*100/getTotalSupply).toFixed(2) + '%)'}}<br />
                      <b-link :href="'https://opensea.io/accounts/' + data.item.owner + '?search[sortAscending]=false&search[sortBy]=LAST_TRANSFER_DATE'" v-b-popover.hover="'VIEW OWNER ACCOUNT IN OPENSEA'" target="_blank">
                         <b-icon-link shift-v="+1" font-scale="1.0"></b-icon-link>
                      </b-link>
                      <b-link size="sm" @click="settings.searchAccount = data.item.owner; tabIndex = 0; recalculate('ownerSearch'); " variant="outline-primary" v-b-popover.hover="'FILTER BY OWNER ACCOUNT'" >
                        <b-icon-search shift-v="+1" font-scale="1.0"></b-icon-search>
                      </b-link>
                    </template>
                    <template #cell(tokens)="data">
                      <span v-for="token in data.item.tokens">
                        <b-link :href="'https://opensea.io/assets/0x31385d3520bced94f77aae104b406994d8f2168c/' + token" v-b-popover.hover="'VIEW IN OPENSEA'" target="_blank">
                          {{ token }}
                        </b-link>
                      </span>
                    </template>
                  </b-table>
                </b-card-text>
              </b-tab>

              <!--
              <b-tab title="LOADMAP">
                <b-card-text>
                  LOTS OF FEATURES INCLUDING NAMING YOUR BASTARDS ON-CHAIN (FOR #ETHERNITY, IN ALL SPACETIME HUMANS WILL VENTURE TO); A DECENTRALISED NFT EXCHANGE. THE DECENRALISED DESING SPACE IS STIL BEING EXPLORED, AND IS SOOO SWEET. NO PROMISES. SOFTWARE GETS DONE WHEN IT GETS DONE. IF YOU WANT TO HELP CONTRIBUTE TO BUILDING THIS SPACE, SEND A FEW (OR LOTS) OF YOUR FLOOR (OR YOUR BEST) BGANPUNKS TO BOKKYPOOBAH.ETH! FOR AWARDING IN THE UPCOMING ETHEREUM DEV/COMMUNITY OG AWARDS! TO THE MANY PEOPLE WHO HAVE BEEN BUIDLING THE DECETRALISED TECHNOLOGY YOU ARE NOW USING. THEY ARE BUIDLING OUR FUTURE. AND OUR CHILDREN^CHILDREN'S FUTURE. ANY UN-ADOPTED DONATED BGANPUNGS WILL BE SENT BACK TO THE ORIGINAL ADDRESS AFTER THEH AWARDS. DON'T BE A FUCKING STINGY BASTARD!
                </b-card-text>
              </b-tab>
              -->

              <!--
              <b-tab title="SETTINGS">
                <b-card-text>
                  Portfolios: {
                    "a": [
                      "0x01",
                      "0x02",
                    ]
                  }
                  SELECT <em>MY SEXY BASTARDS</em> IN THE PREVIOUS TAB TO VIEW YOUR BASTARDS.<br />
                  <b-table small :fields="ownedTokenFields" :items="getOwnedTokenIdData" responsive="sm">
                  </b-table>
                </b-card-text>
              </b-tab>
              -->

              <b-tab title="INFO">
                <h6 class="mb-1">WHAT IS THIS WEBSHITE ABOUT?</h6>
                <b-card-text>
                  A SMOL WEB3 APP TO VIEW YOUR BASTARD GAN PUNKS FROM <a href="https://www.bastardganpunks.club/" target="_blank">https://www.bastardganpunks.club/</a>. OPEN SAUCED CODE IS AVAILBLE FOR YOUR TO IMPROVE ON - SEE BELOW.

                  THIS SITE CURRENTLY LISTS BGANPUNKV2 (VERSION 2) NFTS, NOT BGANPUNKV1 (VERSION 1) <a href="https://bganpunks.eth.link/" target="_blank">https://bganpunks.eth.link/</a>.

                  READ MORE ABOUT BGANPUNKS AT <a href="https://mooncat888.medium.com/introduction-to-bastard-gan-punk-v2-nft-art-collection-c5bb0750432c" target="_blank">Introduction to Bastard Gan Punk V2 NFT art collection</a> and <a href="https://everipedia.org/wiki/lang_en/bastard-gan-punks" target="_blank">Bastard Gan Punks</a>.
                </b-card-text>

                <b-card-text>
                  WER ARE NOT AFFILIATED WITH <a href="https://twitter.com/bganpunks" target="_blank">THESE BASTARDS</a> WITH A SANDWICH LOGO. IF YOU HAVE QUESTIONS, HEAD OVER TO THEIR DISCORD, LINEKD FROM THE URLS ABOVE.
                  <b-card no-body img-src="images/Twitter_bganpunks.png" style="max-width: 20rem;" class="mt-1 ml-5"></b-card>
                </b-card-text>

                <b-card-text>
                  NFT AND IMAGE COPYRIGHT INFO SEE <a href="https://www.bastardganpunks.club/#nftownership" target="_blank">https://www.bastardganpunks.club/#nftownership</a>.

                  A COPY OF THE <a href="https://drive.google.com/drive/folders/1dLnTSUhDlgfdUlzwm1pamiAWUyGVOGj-" target="_blank">HYPED AF MOSAICS</a> HAS BEEN INCLUDED WITH THIS WEBSHITE TO ORGANISE FOR EASIER ACCESS. ONLY THE HYPED AF (ANIMATED) MOSAICS IN THE FIRST 9,000 (#0 to #8,999) TOKENS HAVE BEEN ORGANISED AND THIS REPOSITORY WILL HAVE TO BE UPDATED WHEN THE ORGANISED MOSAICS ARE FINALLY PUBLISHED.
                </b-card-text>

                <h6 class="mt-4 mb-1">HOW DO I ADOPT SOME BASTARDS?</h6>
                <b-card-text>
                  THE LAST BASTARD WAS MINTED (SEE BELOW) AT <a href="https://etherscan.io/tx/0x8540f856b6db0eab792fda749730865a10178260da06541c84cf585d8dc60592" target="_blank">Jun-25-2021 04:53:13 PM +UTC</a> THROUGH A PROXY CONTRACT AND THERE ARE NO MORE BASTARDS TO ADOPT.

                  BGANPUNKV2 NFTS CAN BE PURCHASED FROM SECONDARY ERC-721 MARKETS SUCH AS <a href="https://opensea.io/collection/bastard-gan-punks-v2" target="_blank">https://opensea.io/collection/bastard-gan-punks-v2</a>.

                  SEE ALSO <a href="https://allbastards.com/" target="_blank">https://allbastards.com/</a> and <a href="https://nftexp.io/explore/bastard-gan-punks-v2" target="_blank">https://nftexp.io/explore/bastard-gan-punks-v2</a> FOR MORE INFROMATION.

                  THIS IS NOT FINANCIAL ADVICE. DO YOUR OWN FUCKING RESEARCH. DISCLOSURE - I HAVE SOME BGANPUNKS.
                </b-card-text>

                <h6 class="mt-4 mb-1">CONTRACT DETAILS</h6>
                <b-card-text>
                  THE BGANPUNV2 NFT SMART CONTRACT AT <a href="https://etherscan.io/address/0x31385d3520bCED94f77AaE104b406994D8F2168C#code" target="_blank">0x31385d3520bCED94f77AaE104b406994D8F2168C</a>:
                  <ul>
                    <li>WAS DEPLOYED AT <a href="https://etherscan.io/tx/0xd875fb294bf841eaf7bffae94bd5488d78f227e9b4a3017105bae31b296419ce" target="_blank">Mar-07-2021 12:03:56 PM +UTC</a> WHERE TOKENS #0 TO 33 WERE MINTED</li>
                    <li>MINTED THE FINAL TOKEN #11,304 AT <a href="https://etherscan.io/tx/0x8540f856b6db0eab792fda749730865a10178260da06541c84cf585d8dc60592" target="_blank">Jun-25-2021 04:53:13 PM +UTC</a> THROUGH A PROXY CONTRACT WITH A DECLINING PRICE</li>
                  </ul>
                  <b-card img-src="images/EtherScan_BGANPUNKSV2_20210703_2211.png" style="max-width: 40rem;" class="ml-5">
                    <b-card-text>
                      ETHERSCAN'S <a href="https://etherscan.io/token/tokenholderchart/0x31385d3520bced94f77aae104b406994d8f2168c" target="_blank">BASTARD GAN PUNKS V2 TOKEN HOLDERS @ Jul 3 2021</a>
                    </b-card-text>
                  </b-card>
                </b-card-text>

                <h6 class="mt-4 mb-1">ABOUT THIS APP</h6>
                <b-card-text>
                  <ul>
                    <li>SOURCE CODE AVAILABLE AT <a href="https://github.com/bokkypoobah/BestBastardGANPunks" target="_blank">https://github.com/bokkypoobah/BestBastardGANPunks</a>. CLONE IT, FORK IT. CONTRIBUTE ANY USEFUL CHANGES BACK TO THIS MAIN REPOSITORY.</li>
                    <li>THE MAIN BIT OF CODE IS IN <a href="https://github.com/bokkypoobah/BestBastardGANPunks/blob/main/docs/index.html#L416" target="_blank">https://github.com/bokkypoobah/BestBastardGANPunks/blob/main/docs/index.html</a>.</li>
                    <li>TO SEE HOW IT WORKS, SWITCH TO YOUR WEB BEOWSER DEVELOPER CONSOLE AND TRY STRPPING THROUGH THE SOURCE CODE.</li>
                    <li>WRITTEN USING THE <a href="https://bootstrap-vue.org/" target="_blank">https://bootstrap-vue.org/</a> FRAMEWWORK</li>
                    <li>GENERATES "STATIC" DATA BY COLLATING INFOTMSTION FROM THE TOKEN CONTACT'S <em>tokenURI(...)</em> INFORMATION WITH THE INFOTRMATION FROM OPENSEA.IO.</li>
                    <li>USES <a href="https://github.com/ethers-io/ethers.js/" target="_blank">ETHERS.JS</a> TO CONNECT TO ETHERUEM VIA WEB3 TO RETRIEVE NFT TOKENS OWNED</li>
                    <li>HAS NO TRACKIING TECHNOLOGY. HOWEVER CONNECTIONS FROM THIS APP TO OPENSEA AND YOUR WEB3 PROVIDER WILL LEAK SOME INFORMATION.</li>
                    <li>CAN BE RUN ON YOUR OWN COMPUTER BY CLONING THE GITHUB REPOSITORY AND SERVING THE PAGES USING A WEBSERVER, OR THE "ANYWHERE" SERVER.</li>
                    <li>CAN BE RUN FROM GITHUB PAGES, SO YOU CAN EASILY CLONE, CUSTOMISE AND SERVE YOUR OWN VERSION</li>
                    <li>THIS APP DOES ADD A REF LINK TO MY ACCOUNT TO OPENSEA URLS</li>
                    <li>HAS SOME CODE FROM THE IS IT CLEAN TOOL BY <a href="https://twitter.com/yungwknd" target="_blank">@yungwknd</a></li>
                  </ul>
                </b-card-text>

                <h6 class="mt-4 mb-1">SUPPORT A POOR DEVLOPER BASTARD</h6>
                <b-card-text>
                  <ul>
                    <li>SEND YOUR FUCKING DONATIONS TO BokkyPooBah.eth. FLOOR BGANPUNKV2S, NFTS, ETH AND ERC20S ALL APPRECIATED. DON'T BE A FUCKING STINGY BASTARD!!!</li>
                  </ul>
                </b-card-text>

                <b-card-text class="ml-5 mt-5">
                  ENJOY!
                  <b-card no-body img-src="images/DoomedDegen.png" style="max-width: 20rem;" class="mt-1 ml-2"></b-card>
                  (C) BOKKYPOOBAH / BOK CONSULTING PTY LTD 2021. THE MIT LICENCE.
                </b-card-text>
              </b-tab>
            </b-tabs>
          </b-card>
        </div>
      </b-container>
    </div>

    <script>
      window.app = new Vue({
        el: '#app',
        data: {
          processing: null,
          connected: false,
          account: null,
          // accounts: [],
          tokensOwned: [],
          owners: [],
          ensMap: {},
          osData: {},
          tags: {},
          selectedTags: [],
          collatedOwners: [],
          tabIndex: 0,

          data: [],
          categories: {},

          settings: {
            contract: {
              address: null,
              name: null,
              symbol: null,
              totalSupply: null,
              loaded: null,
            },
            advancedSearch: false,
            cardView: false,
            searchTokenId: '',
            searchLyrics: '',
            searchAccount: '',
          },

          tokensSearchResults: [],

          tokensCurrentPage: 1,
          tokensPageSize: 100,
          ownersCurrentPage: 1,
          ownersPageSize: 10,

          pageSizes: [
            { value: 10, text: '10/P' },
            { value: 100, text: '100/P' },
            { value: 666, text: '666/P' },
            { value: 1000, text: '1,000/P' },
            { value: 2145, text: '2,145/P' },
            { value: 66666, text: 'ALL' },
          ],

          selectedTokenId: null,
          selectedItemFrame: 0,
          selectedItemFrames: null,
          selectedItemIsGIF: false,
          selectedItemGIF: null,

          cardImageSizeCurrent: '300',
          cardImageSizeOptions: [
            { value: '93', text: '93%' },
            { value: '100', text: '100%' },
            { value: '200', text: '200%' },
            { value: '300', text: '300%' },
            { value: '500', text: '500%' },
            { value: '750', text: '750%' },
            { value: '1000', text: '1,000%' },
            { value: '1500', text: '1,500%' },
            { value: '3000', text: '3,000%' },
            { value: '6000', text: '6,000%' },
            { value: '12000', text: '12,000%' },
          ],

          categoryFields: [
            { key: 'select', label: '', thStyle: 'width: 10%;' },
            { key: 'categoryOption', label: 'TYPE', sortable: true },
            { key: 'categoryTotal', label: 'COUNT', sortable: true, thStyle: 'width: 30%;', thClass: 'text-right', tdClass: 'text-right' },
          ],
          categoryFilter: {},
          fields: [
            { key: 'image', label: 'BASTARD', thStyle: 'width: 25%;' },
            { key: 'tokenId', label: 'INFO', thStyle: 'width: 25%;' },
            { key: 'attributes', label: 'ATTRIBUTES', thStyle: 'width: 25%;' },
            { key: 'description', label: 'LYRICS', thStyle: 'width: 25%;' },
          ],
          sellOrdersFields: [
            { key: 'eth', label: 'ETH' },
            { key: 'created', label: 'LISTED' },
          ],
          ownersFields: [
            { key: 'index', label: '#' },
            { key: 'owner', label: 'OWNER' },
            { key: 'tokens', label: 'TONKENS' },
          ],
          bokkysBastards: [
            { tokenId: 471, image: "bganpunkv2_471.png" },
            { tokenId: 1147, image: "bganpunkv2_1147.png" },
            { tokenId: 3053, image: "bganpunkv2_3053.gif" },
            { tokenId: 4027, image: "bganpunkv2_4027.png" },
            { tokenId: 4793, image: "bganpunkv2_4793.png" },
            { tokenId: 6285, image: "bganpunkv2_6285.png" },
            { tokenId: 7008, image: "bganpunkv2_7008.png" },
            { tokenId: 7222, image: "bganpunkv2_7222.gif" },
            { tokenId: 7567, image: "bganpunkv2_7567.png" },
            { tokenId: 7776, image: "bganpunkv2_7776.png" },
            { tokenId: 7850, image: "bganpunkv2_7850.png" },
            { tokenId: 9158, image: "bganpunkv2_9158.png" },
            { tokenId: 9362, image: "bganpunkv2_9362.png" },
            { tokenId: 10375, image: "bganpunkv2_10375.gif" },
            { tokenId: 10449, image: "bganpunkv2_10449.gif" },
            { tokenId: 10724, image: "bganpunkv2_10724.gif" },
            { tokenId: 10729, image: "bganpunkv2_10729.gif" },
            { tokenId: 10735, image: "bganpunkv2_10735.gif" },
            { tokenId: 10737, image: "bganpunkv2_10737.png" },
            { tokenId: 10834, image: "bganpunkv2_10834.gif" },
            { tokenId: 11100, image: "bganpunkv2_11100.png" },
            { tokenId: 11258, image: "bganpunkv2_11258.png" },
          ],
        },

        computed: {
          getTotalSupply() {
            return this.data.length;
          },
          pagedTokensResults() {
            return this.tokensSearchResults.slice((this.tokensCurrentPage - 1) * this.tokensPageSize, this.tokensCurrentPage * this.tokensPageSize);
          },
          pagedCollatedOwnersResults() {
            return this.collatedOwners.slice((this.ownersCurrentPage - 1) * this.ownersPageSize, this.ownersCurrentPage * this.ownersPageSize);
          },
          getSelectedShowcase() {
            const MAXBASTARDSTODISPLAY = 18;
            function shuffleArray(array) {
              for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
              }
            }
            // let tokenIdsOwned = this.tokensOwned.slice(0);
            // if (tokenIdsOwned.length == 0) {
            //   tokenIdsOwned = this.bokkysBastards.slice(0);
            // }
            let tokenIdsOwned = this.bokkysBastards.slice(0);
            shuffleArray(tokenIdsOwned);
            return tokenIdsOwned.slice(0, MAXBASTARDSTODISPLAY);
          },
          getTags() {
            const collator = {};
            for (const [key, value] of Object.entries(this.tags)) {
              for (let i = 0; i < value.length; i++) {
                const tag = value[i];
                if (!collator[tag]) {
                  collator[tag] = 1;
                } else {
                  collator[tag] = parseInt(collator[tag]) + 1;
                }
              }
            }
            let results = [];
            results.push({ value: null, text: '(All)' });
            for (const [key, value] of Object.entries(collator)) {
              results.push({ value: key, text: key + ' (' + value + ')' });
            }
            results.sort(function(a, b) {
              return b.count - a.count;
            });
            return results;
          }
        },


        methods: {

          <!-- Recalculation -->
          async recalculate(from) {
            console.log(new Date().toUTCString() + " recalculate(from: " + from + ") start");

            if (from != 'selectedTags') {
              await this.processOSData();
              // this.data = BASTARDDATA;
              // this.generateTokenData();
              // this.calculateTokensOwned();
              // this.calculateCategories();
            }
            this.tokensSearchResults = this.calculateSearchResults();
            // this.collatedOwners = this.calculateCollatedOwners();
            this.saveSettings();
            console.log(new Date().toUTCString() + " recalculate(from: " + from + ") completed");
          },

          async processOSData() {
            console.log(new Date().toUTCString() + " processOSData() start");
            var db0 = new Dexie("LostDB");
            db0.version(1).stores({
              // apiData: 'contract,tokenId,asset,timestamp'
              apiData: '[contract+tokenId],contract,tokenId,asset,timestamp'
            });
            const tokenIdIndex = {};
            const results = [];
            for (let i = 0; i < this.owners.length; i++) {
              tokenIdIndex[this.owners[i].tokenId] = i;
              results.push(this.owners[i]);
            }
            console.log(JSON.stringify(results.slice(0, 5), null, 2));
            // console.log(JSON.stringify(tokenIdIndex, null, 2));

            if (this.settings.contract.address && this.settings.contract.address.length > 1) {
              const osAssets = await db0.apiData.where("contract").equalsIgnoreCase(this.settings.contract.address).toArray();
              const osData = {};
              // console.log(JSON.stringify(osAssets.slice(0, 3), null, 2));
              for (const asset of osAssets) {
                if (asset.tokenId == 5389) {
                  console.log(JSON.stringify(asset, null, 2));
                }
                let lastSale = null;
                if (asset.asset.last_sale) {
                  lastSale = {
                    totalPrice: new BigNumber(asset.asset.last_sale.total_price).shift(-18),
                    symbol: asset.asset.last_sale.payment_token.symbol,
                    decimals: asset.asset.last_sale.payment_token.decimals,
                    ethPrice: asset.asset.last_sale.payment_token.eth_price,
                    usdPrice: asset.asset.last_sale.payment_token.usd_price,
                    tx: asset.asset.last_sale.transaction.transaction_hash,
                    assetBundle: asset.asset.last_sale.asset_bundle,
                    eventType: asset.asset.last_sale.event_type,
                    eventTimestamp: asset.asset.last_sale.event_timestamp,
                  }
                }
                let sellOrder = null;
                if (asset.asset.sell_orders) {
                  const numberSellOrders = asset.asset.sell_orders.length;
                  if (numberSellOrders > 1) {
                    console.log("WARNING: numberSellOrders > 1 #" + asset.tokenId + " " + JSON.stringify(asset.asset, null, 2));
                  }
                  for (const so of asset.asset.sell_orders) {
                    sellOrder = {
                      basePrice: so.base_price,
                      currentPrice: new BigNumber(so.current_price).shift(-18),
                      symbol: so.payment_token_contract.symbol,
                      decimals: so.payment_token_contract.decimals,
                      ethPrice: so.payment_token_contract.eth_price,
                      usdPrice: so.payment_token_contract.usd_price,
                      cancelled: so.cancelled,
                      feeMethod: so.fee_method,
                      side: so.side,
                      saleKind: so.sale_kind,
                      createdDate: so.created_date,
                      closingDate: so.closing_date,
                      closingExtendable: so.closing_extendable,
                      expirationTime: so.expiration_time,
                      listingTime: so.listing_time,
                    };
                  }
                }
                const result = results[tokenIdIndex[asset.tokenId]];
                result.name = asset.asset.name;
                result.description = asset.asset.description;
                result.externalLink = asset.asset.external_link;

                result.imageOriginalURL = asset.asset.image_original_url;
                result.imagePreviewURL = asset.asset.image_preview_url;
                result.imageThumbnailURL = asset.asset.image_thumbnail_url;
                result.imageURL = asset.asset.image_url;
                result.osOwner = asset.asset.owner.address;
                result.numSales = asset.asset.num_sales;
                result.tokenMetadata = asset.asset.token_metadata;
                result.permalink = asset.asset.permalink;

                result.sellOrder = sellOrder;
                result.lastSale = lastSale;
                result.traits = asset.asset.traits;
                // console.log("result: " + JSON.stringify(result));
                osData[asset.tokenId] = { sellOrder: sellOrder, lastSale: lastSale };
              }
              // console.log(JSON.stringify(osData, null, 8));
              this.osData = osData;
            }
            console.log(JSON.stringify(this.owners.slice(0, 5), null, 2));
            console.log(JSON.stringify(results.slice(0, 5), null, 2));
            this.data = results;
            console.log(new Date().toUTCString() + " processOSData() completed");
          },

          generateTokenData() {
            const results = [];
            for (const record of this.owners) {
              // console.log(new Date().toUTCString() + " - calculateTokensOwned() record: " + JSON.stringify(record));
              results.push(record);
            }
            // if (this.owners.length > 0) {
              // const account = this.account.toLowerCase();
              // console.log(new Date().toUTCString() + " - calculateTokensOwned() account: " + JSON.stringify(account));
              // for (let i in BASTARDDATA) {
              //   const item = BASTARDDATA[i];
              //   const owner = this.owners[i] ? this.owners[i].owner : null;
              //   if (owner && owner.toLowerCase() == account) {
              //     results.push(item.tokenId);
              //   }
              // }
            // }
            console.log(new Date().toUTCString() + " - calculateTokensOwned() completed: " + JSON.stringify(results));
            this.data = results;
          },


          calculateTokensOwned() {
            const results = [];
            if (this.owners.length > 0 && this.account) {
              const account = this.account.toLowerCase();
              console.log(new Date().toUTCString() + " - calculateTokensOwned() account: " + JSON.stringify(account));
              for (let i in BASTARDDATA) {
                const item = BASTARDDATA[i];
                const owner = this.owners[i] ? this.owners[i].owner : null;
                if (owner && owner.toLowerCase() == account) {
                  results.push(item.tokenId);
                }
              }
            }
            console.log(new Date().toUTCString() + " - calculateTokensOwned() completed: " + JSON.stringify(results));
            this.tokensOwned = results;
          },

          calculateCategories() {
            const collator = {};
            for (let i in this.data) {
              const item = this.data[i];
              for (let k in item.attributes) {
                const attribute = item.attributes[k];
                const traitType = attribute.trait_type;
                const value = attribute.value;
                if (!collator[traitType]) {
                  collator[traitType] = {};
                }
                if (!collator[traitType][value]) {
                  collator[traitType][value] = 1;
                } else {
                  collator[traitType][value] = collator[traitType][value] + 1;
                }
              }
            }
            console.log(new Date().toUTCString() + " - calculateCategories() completed");
            this.categories = collator;
          },

          calculateSearchResults() {
            const accountLowerCase = this.account == null ? null : this.account.toLowerCase();
            const selectedTags = this.selectedTags == null || (this.selectedTags.length == 1 && this.selectedTags[0] == null) ? null : this.selectedTags;

            function getAttribute(data1, category) {
              for (let attributeIndex in data1.attributes) {
                const attribute = data1.attributes[attributeIndex];
                if (attribute.trait_type == category) {
                  return attribute.value;
                }
              }
              return null;
            }

            let data = this.data.slice(0);
            let stage1Data = data;
            if (this.settings.searchTokenId != null && this.settings.searchTokenId.length > 0) {
              const searchTokenIds = this.settings.searchTokenId.split(",");
              stage1Data = [];
              for (s of searchTokenIds) {
                if (s >= 0 && s < this.getTotalSupply) {
                  stage1Data.push(data[s]);
                }
              }
            }

            let stage2Data = stage1Data;
            if (this.settings.searchLyrics != null && this.settings.searchLyrics.length > 0) {
              const s = this.settings.searchLyrics.toLowerCase();
              console.log("s: " + s);
              stage2Data = [];
              for (let i in stage1Data) {
                const d = stage1Data[i];
                const include = d.description.toLowerCase().includes(s);
                if (d.description && d.description.toLowerCase().includes(s)) {
                  if (i < 10) {
                    console.log("stage1Data[" + i + "].description: " + JSON.stringify(d.description) + ", include: " + include);
                  }
                  stage2Data.push(d);
                }
              }
            }
            console.log("stage2Data.length: " + stage2Data.length);

            let stage3Data = stage2Data;
            if (this.settings.searchAccount != null && this.settings.searchAccount.length > 0) {
              const searchAccounts = this.settings.searchAccount.split(",");
              stage3Data = [];
              for (let i in stage2Data) {
                const d = stage2Data[i];
                const owner = this.owners[d.tokenId] ? this.owners[d.tokenId].toLowerCase() : null;
                const ensName = owner == null ? null : this.ensMap[owner].owner;
                for (searchAccount of searchAccounts) {
                  const s = searchAccount.toLowerCase();
                  if (owner != null && owner.includes(s)) {
                    stage3Data.push(d);
                    break;
                  } else if (ensName != null && ensName.includes(s)) {
                    stage3Data.push(d);
                    break;
                  }
                }
              }
            }
            console.log("stage3Data.length: " + stage3Data.length);

            let results = [];
            for (let i in stage3Data) {
              const d = stage3Data[i];
              let include = true;
              for (const [key, value] of Object.entries(this.categoryFilter)) {
                const attributeValue = getAttribute(d, key);
                if (!value[attributeValue]) {
                  include = false;
                  break;
                }
              }
              if (include) {
                if (selectedTags && selectedTags.length > 0) {
                  const tags = this.tags[d.tokenId];
                  let found = false;
                  if (tags) {
                    for (const selectedTag of selectedTags) {
                      for (const tag of tags) {
                        if (selectedTag == tag) {
                          found = true;
                          break;
                        }
                      }
                    }
                  }
                  if (!found) {
                    include = false;
                  }
                }
              }
              if (include) {
                results.push(d);
              }
            }
            console.log(new Date().toUTCString() + " - calculateSearchResults() completed");
            return results;
          },

          calculateCollatedOwners() {
            let results = [];
            if (this.owners.length > 0) {
              const collator = {};
              for (let i in this.data) {
                const item = this.data[i];
                const owner = this.owners[i];
                if (!collator[owner]) {
                  collator[owner] = [];
                }
                collator[owner].push(item.tokenId);
              }
              for (const [key, value] of Object.entries(collator)) {
                results.push({ owner: key, tokens: value, count: value.length });
              }
              results.sort(function(a, b) {
                return b.count - a.count;
              });
              for (let i in results) {
                results[i].index = i;
              }
            }
            console.log(new Date().toUTCString() + " - calculateCollatedOwners() completed");
            return results;
          },

          // --- Web3 Connection ---
          async connect() {
            if (!window.ethereum) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser, if you would like to view your Ethereum wallet's BGANPUNKSV2.");
              this.connected = false;
              this.account = null;
            } else {
              if (!window.ethereum.isConnected() || !window.ethereum['isUnlocked']) {
                try {
                  const t = this;
                  function handleAccountsChanged(accounts) {
                    console.log("handleAccountsChanged: " + JSON.stringify(accounts));
                    t.account = accounts[0];
                    localStorage.setItem('lostMyAccount', JSON.stringify(t.account));
                    t.recalculate('web3 account update');
                  }
                  if (!this.connected) {
                    window.ethereum.on('accountsChanged', handleAccountsChanged);
                  }

                  const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                  this.account = accounts[0];
                  localStorage.setItem('lostMyAccount', JSON.stringify(this.account));
                } catch (e) {
                  console.log("connect(): Error connecting");
                }
              }
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              const network = await provider.getNetwork();
              if (network.chainId == 1) {
                this.connected = true;
                this.recalculate('data loaded via web3');
              } else {
                alert("Please switch to the Ethereum mainnet and refresh");
              }
            }
          },
          async loadERC721TokenInfo() {
            console.log("loadERC721TokenInfo: " + JSON.stringify(this.settings.contract));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const erc721Helper = new ethers.Contract(ERC721HELPERADDRESS, ERC721HELPERABI, provider);
            const info = await erc721Helper.tokenInfo(this.settings.contract.address);
            this.settings.contract.symbol = info[0];
            this.settings.contract.name = info[1];
            this.settings.contract.totalSupply = parseInt(info[2].toString());
          },
          async loadERC721TokenIdsAndOwners() {
            console.log("loadERC721TokenIdsAndOwners: " + JSON.stringify(this.settings.contract));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const erc721Helper = new ethers.Contract(ERC721HELPERADDRESS, ERC721HELPERABI, provider);
            const owners = [];
            const NFTOWNERBATCHSIZE = 500;
            const totalSupply = this.settings.contract.totalSupply;
            for (let i = 0; i < totalSupply; i += NFTOWNERBATCHSIZE) {
              const to = (i + NFTOWNERBATCHSIZE > totalSupply) ? totalSupply : i + NFTOWNERBATCHSIZE;
              // this.processing = "RETRIEVING LIVE BGANPUNKSV2 ONWERSHIP RECORDS FROM THE ETHEREUM MAINNET: " + ethers.utils.commify(i) + " - " + ethers.utils.commify(parseInt(to) - 1) + " OF " + ethers.utils.commify(totalSupply);
              const ownersResult = await erc721Helper.owners(this.settings.contract.address, i, to);
              console.log(new Date().toUTCString() + " from: " + i + ", to: " + to + ", size: " + ownersResult[0].length);
              for (let j = 0; j < ownersResult[0].length; j++) {
                owners.push({ tokenId: ownersResult[0][j].toString(), owner: ownersResult[1][j] });
              }
            }
            console.log(JSON.stringify(owners, null, 2));
            this.owners = owners;
            localStorage.setItem('lostOwners', JSON.stringify(owners));
            const ensMap = {};

            ensMap[this.account.toLowerCase()] = this.account.toLowerCase();
            for (const record of owners) {
              console.log(JSON.stringify(record, null, 2));
              const owner = record.owner.toLowerCase();
              if (!ensMap[owner]) {
                ensMap[owner] = owner;
              }
            }
            console.log(JSON.stringify(ensMap, null, 2));
            let addresses = Object.keys(ensMap);
            const ensReverseRecordsContract = new ethers.Contract(ENSREVERSERECORDSADDRESS, ENSREVERSERECORDSABI, provider);
            const ENSOWNERBATCHSIZE = 500;
            for (let i = 0; i < addresses.length; i += ENSOWNERBATCHSIZE) {
            //   this.processing = "RETRIEVING LIVE ENS REVERSE RECORDS FROM THE ETHEREUM MAINNET: " + ethers.utils.commify(i) + " OF " + ethers.utils.commify(addresses.length);
              const batch = addresses.slice(i, parseInt(i) + ENSOWNERBATCHSIZE);
              const allnames = await ensReverseRecordsContract.getNames(batch);
            //   // NOT CHECKING ADDRESSES AS THE ADDRESSES CAME FROM A CONTRACT. AND account. const validNames = allnames.filter((n) => normalize(n) === n );
              for (let j = 0; j < batch.length; j++) {
                const address = batch[j];
                const name = allnames[j];
                ensMap[address] = name != null && name.length > 0 ? name : address;
                // const normalized = normalize(address);
              }
            }
            ensMap["0x000000000000000000000000000000000000dEaD".toLowerCase()] = "0xdEaD_";
            console.log(JSON.stringify(ensMap, null, 2));
            this.ensMap = ensMap;
            localStorage.setItem('lostENSMap', JSON.stringify(ensMap));
            // // this.processing = "RECALCULATING DATA";
            this.recalculate('loadERC721TokenIdsAndOwners()');
          },

          async connect1_todelete() {
            if (!window.ethereum) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser, if you would like to view your Ethereum wallet's BGANPUNKSV2.");
              this.connected = false;
              this.account = null;
            } else {
              if (!window.ethereum.isConnected() || !window.ethereum['isUnlocked']) {
                try {
                  const t = this;
                  function handleAccountsChanged(accounts) {
                    console.log("handleAccountsChanged: " + JSON.stringify(accounts));
                    t.account = accounts[0];
                    localStorage.setItem('lostMyAccount', JSON.stringify(t.account));
                    t.recalculate('web3 account update');
                  }
                  if (!this.connected) {
                    window.ethereum.on('accountsChanged', handleAccountsChanged);
                  }

                  const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                  this.account = accounts[0];
                  localStorage.setItem('lostMyAccount', JSON.stringify(this.account));
                } catch (e) {
                  console.log("connect(): Error connecting");
                }
              }
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              const network = await provider.getNetwork();
              if (network.chainId == 1) {
                this.connected = true;
                const erc721Helper = new ethers.Contract(ERC721HELPERADDRESS, ERC721HELPERABI, provider);
                const info = await erc721Helper.tokenInfo(BASTARDADDRESS);
                const totalSupply = parseInt(info[2].toString());
                console.log(new Date().toUTCString() + " info:" + JSON.stringify(info));
                const owners = [];
                const NFTOWNERBATCHSIZE = 500;
                for (let i = 0; i < totalSupply; i += NFTOWNERBATCHSIZE) {
                  const to = (i + NFTOWNERBATCHSIZE > totalSupply) ? totalSupply : i + NFTOWNERBATCHSIZE;
                  this.processing = "RETRIEVING LIVE BGANPUNKSV2 ONWERSHIP RECORDS FROM THE ETHEREUM MAINNET: " + ethers.utils.commify(i) + " - " + ethers.utils.commify(parseInt(to) - 1) + " OF " + ethers.utils.commify(totalSupply);
                  const ownersResult = await erc721Helper.owners(BASTARDADDRESS, i, to);
                  console.log(new Date().toUTCString() + " from: " + i + ", to: " + to + ", size: " + ownersResult[0].length);
                  for (let j = 0; j < ownersResult[0].length; j++) {
                    owners.push(ownersResult[1][j]);
                  }
                }
                this.owners = owners;
                localStorage.setItem('lostOwners', JSON.stringify(owners));
                const ensMap = {};
                for (let i in owners) {
                  const owner = owners[i].toLowerCase();
                  if (!ensMap[owner]) {
                    ensMap[owner] = owners[i];
                  }
                }
                ensMap[this.account.toLowerCase()] = this.account;
                ensMap["0x000000000000000000000000000000000000dEaD".toLowerCase()] = "0DEAD_";
                ensMap["0xcCcBF11AC3030ee8CD7a04CFE15a3718df6dD030".toLowerCase()] = "NFT20_";
                let addresses = Object.keys(ensMap);
                const ensReverseRecordsContract = new ethers.Contract(ENSREVERSERECORDSADDRESS, ENSREVERSERECORDSABI, provider);
                const ENSOWNERBATCHSIZE = 500;
                for (let i = 0; i < addresses.length; i += ENSOWNERBATCHSIZE) {
                  this.processing = "RETRIEVING LIVE ENS REVERSE RECORDS FROM THE ETHEREUM MAINNET: " + ethers.utils.commify(i) + " OF " + ethers.utils.commify(addresses.length);
                  const batch = addresses.slice(i, parseInt(i) + ENSOWNERBATCHSIZE);
                  const allnames = await ensReverseRecordsContract.getNames(batch);
                  // NOT CHECKING ADDRESSES AS THE ADDRESSES CAME FROM A CONTRACT. AND account. const validNames = allnames.filter((n) => normalize(n) === n );
                  for (let j = 0; j < batch.length; j++) {
                    const address = batch[j];
                    const name = allnames[j];
                    ensMap[address] = name != null && name.length > 0 ? name : address;
                    // const normalized = normalize(address);
                  }
                }
                this.ensMap = ensMap;
                localStorage.setItem('lostENSMap', JSON.stringify(ensMap));
                this.processing = "RECALCULATING DATA";
                this.recalculate('data loaded via web3');
                this.processing = null;
              } else {
                alert("Please switch to the Ethereum mainnet and refresh");
              }
            }
          },
          disconnect() {
            this.connected = false;
          },

          // --- OS Data Retrieval ---
          async loadOSData() {
            console.log(new Date().toUTCString() + " loadOSData() start");
            var db0 = new Dexie("LostDB");
            db0.version(1).stores({
              apiData: '[contract+tokenId],contract,tokenId,asset,timestamp'
            });
            const timestamp = parseInt(new Date() / 1000);
            const BATCHSIZE = 50; // Max 50
            const DELAYINMILLIS = 100;
            let page = 0;
            const records = [];
            const delay = ms => new Promise(res => setTimeout(res, ms));
            await delay(DELAYINMILLIS);
            console.log(new Date().toUTCString() + " loadOSData() this.owners: " + JSON.stringify(this.owners));
            const to = this.settings.contract.totalSupply;
            console.log(new Date().toUTCString() + " loadOSData() to: " + to);
            const contract = this.settings.contract.address.toLowerCase();
            console.log(new Date().toUTCString() + " loadOSData() contract: " + contract);
            if (this.settings.loaded == null) {
              this.settings.contract.loaded = 0;
            }
            console.log(new Date().toUTCString() + " loadOSData() this.settings.contract.loaded: " + this.settings.contract.loaded);

            for (let i = this.settings.contract.loaded; i < to; i += BATCHSIZE) {
              let url = "https://api.opensea.io/api/v1/assets?asset_contract_address=" + contract + "\&order_direction=desc\&limit=50\&offset=0";
              for (let j = i; j < i + BATCHSIZE && j < to; j++) {
                url = url + "&token_ids=" + this.owners[j].tokenId;
              }
              console.log(url);
              const elapsed = parseInt(new Date() / 1000) - timestamp;
              // this.processing = "DOWNLOADING LIVE DATA FROM OPENSEA: " + ethers.utils.commify(i) + " (BATCH SIZE " + BATCHSIZE + ") OF " + ethers.utils.commify(to) + ". ELAPSED " + elapsed + " SECONDS. CONTINUE BROWSING THE BEAUTIFUL BASTRADS IN THE MEANTIME";
              const data = await fetch(url).then(response => response.json());
              if (data.assets && data.assets.length > 0) {
                for (let assetIndex = 0; assetIndex < data.assets.length; assetIndex++) {
                  this.settings.contract.loaded = parseInt(this.settings.contract.loaded) + 1;
                  const asset = data.assets[assetIndex];
                  records.push({ contract: contract, tokenId: asset.token_id, asset: asset, timestamp: timestamp });
                }
              }
              await delay(DELAYINMILLIS);
              await db0.apiData.bulkPut(records).then (function(){
              }).catch(function(error) {
                console.log("error: " + error);
              });
            }
            this.settings.contract.loaded = null;
            this.recalculate('loaded os data');
            // this.processing = null;
            console.log(new Date().toUTCString() + " loadOSData() completed");
          },

          // --- GIF Frame Extraction ---
          async displayToken(image) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', image);
            const t = this;
            xhr.onload = function() {
              if (xhr.response.substring(0, 3) == "GIF") {
                t.selectedItemIsGIF = true;
              } else {
                t.selectedItemIsGIF = false;
              }
              // TODO
              t.selectedTokenId = image;
              t.$refs['gif-frame-extraction-modal'].show();
            }
            xhr.onerror = function() {
              alert('A network error occurred!');
            };
            xhr.send();
          },
          async onGIFFrameSelectionModalOpened() {
            const t = this;
            var element = document.getElementById("thegif1")
            if (t.selectedItemIsGIF) {
              this.selectedItemGIF = new SuperGif({ gif: element, loop_delay: 2000, max_width: 600, rubbable: true });
              this.selectedItemGIF.load(function(){
                t.selectedItemFrames = t.selectedItemGIF.get_length();
                if (t.selectedItemFrame < 0 || t.selectedItemFrame >= t.selectedItemFrames) {
                  t.selectedItemFrame = 0;
                }
                t.selectedItemGIF.move_to(t.selectedItemFrame);
              });
            }
          },
          setFrame() {
            if (this.selectedItemGIF) {
              this.selectedItemGIF.move_to(this.selectedItemFrame);
            }
          },

          // --- UI Misc ---
          filterChange(category, option) {
            if (!this.categoryFilter[category]) {
              Vue.set(this.categoryFilter, category, {});
            }
            if (this.categoryFilter[category][option]) {
              Vue.delete(this.categoryFilter[category], option);
              if (Object.keys(this.categoryFilter[category]) == 0) {
                Vue.delete(this.categoryFilter, category);
              }
            } else {
              Vue.set(this.categoryFilter[category], option, true);
            }
            this.categoryFilter = this.categoryFilter;
            this.recalculate('filterChange');
          },
          getSortedValuesForCategory(category) {
            const results = [];
            for (let categoryKey in this.categories[category]) {
              const c = this.categories[category][categoryKey];
              results.push({ categoryOption: categoryKey, categoryTotal: c })
            }
            results.sort(function(a, b) {
              return b.categoryTotal - a.categoryTotal;
            });
            return results;
          },

          // --- Utilities ---
          getURL(s) {
            const separator = window.location.href.indexOf("/#/");
            // if (separator > 0) {
            //   const parameter = window.location.href.substring(separator + 3);
            // const prefix = window.location.href.substring(separator + 3);
            return s;
          },
          commify(e) {
            return ethers.utils.commify(e.toString());
          },
          formatDate(d) {
            if (d == 0) {
              return "";
            } else {
              if (new RegExp('^[0-9]+$').test(d)) {
                return new Date(parseInt(d) * 1000).toDateString().substring(4);
              } else {
                return new Date(d).toDateString().substring(4);
              }
            }
          },
          saveTags() {
            for (const [key, value] of Object.entries(this.tags)) {
              if (value.length == 0) {
                Vue.delete(this.tags, key);
              }
            }
            localStorage.setItem('lostTags', JSON.stringify(this.tags));
          },
          saveSettings() {
            localStorage.setItem('lostSettings', JSON.stringify(this.settings));
          },
          ensOrShortName(address) {
            try {
              let name = this.ensMap[address.toLowerCase()];
              if (name != null) {
                name = name.substring(0, 24);
              }
              return name;
            } catch (e) {
              return address;
            }
          },
        },


        mounted() {
          if (localStorage.getItem('lostOwners')) {
            this.owners = JSON.parse(localStorage.getItem('lostOwners'));
          } else {
            this.owners = OWNERSSNAPSHOT;
          }
          if (localStorage.getItem('lostMyAccount')) {
            this.account = JSON.parse(localStorage.getItem('lostMyAccount'));
          }
          if (localStorage.getItem('lostENSMap')) {
            this.ensMap = JSON.parse(localStorage.getItem('lostENSMap'));
          } else {
            this.ensMap = ENSMAPSNAPSHOT;
          }
          if (localStorage.getItem('lostTags')) {
            this.tags = JSON.parse(localStorage.getItem('lostTags'));
          }
          if (localStorage.getItem('lostSettings')) {
            const savedSettings = JSON.parse(localStorage.getItem('lostSettings'));
            if (savedSettings.cardView != null) {
              this.settings = savedSettings;
            }
          }
          const separator = window.location.href.indexOf("/#/");
          if (separator > 0) {
            const parameter = window.location.href.substring(separator + 3);
            if (new RegExp('^[0-9,]+$').test(parameter)) {
              this.settings.searchTokenId = parameter;
            } else {
              this.settings.searchAccount = parameter;
            }
          }
          this.recalculate("mounted");
        }
      })
    </script>
  </body>
</html>
